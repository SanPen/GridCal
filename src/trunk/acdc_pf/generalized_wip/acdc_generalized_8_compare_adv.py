import os
from VeraGridEngine.Simulations.PowerFlow.power_flow_worker import PowerFlowOptions
from VeraGridEngine.Simulations.PowerFlow.power_flow_options import SolverType
import VeraGridEngine.api as gce
import faulthandler
import numpy as np
import os
from VeraGridEngine.Simulations.PowerFlow.Formulations.pf_generalized_formulation import PfGeneralizedFormulation
from VeraGridEngine.Simulations.PowerFlow.Formulations.pf_advanced_formulation import PfAdvancedFormulation
from VeraGridEngine.Simulations.PowerFlow.NumericalMethods.newton_raphson_fx import newton_raphson_fx
from VeraGridEngine.basic_structures import Logger
import faulthandler

faulthandler.enable()  # start @ the beginning

"""
Check that a transformer can regulate the voltage at a bus
"""
# fname = os.path.join("..", "..", "..", "tests", 'data', 'grids', 'Lynn 5 Bus (pq).gridcal')
fname = os.path.join("..", "..", "..", "tests", 'data', 'grids', '5Bus_LTC_FACTS_Fig4.7.gridcal')
grid = gce.open_file(fname)

# run power flow
main_nc = gce.compile_numerical_circuit_at(grid)

islands = main_nc.split_into_islands(
    consider_hvdc_as_island_links=True,
)
print(f"Base: nbus {main_nc.nbus}, nbr: {main_nc.nbr}, nvsc: {main_nc.nvsc}, nhvdc: {main_nc.nhvdc}")

options = gce.PowerFlowOptions(solver_type=gce.SolverType.NR, tolerance=1e-11, verbose=2)
logger = Logger()

island = islands[0]

problem = PfAdvancedFormulation(V0=island.Vbus,
                                   S0=island.Sbus,
                                   I0=island.Ibus,
                                   Y0=island.YLoadBus,
                                   Qmin=island.Qmin_bus,
                                   Qmax=island.Qmax_bus,
                                   nc=island,
                                   options=options,
                                   logger=logger)

print()

solution = newton_raphson_fx(problem=problem,
                             tol=options.tolerance,
                             max_iter=options.max_iter,
                             trust=options.trust_radius,
                             verbose=options.verbose,
                             logger=logger)

print(solution.V)
print(solution.converged)
print(solution.iterations)

